---
import { marked } from 'marked';

// Configure marked for better list handling
marked.setOptions({
  gfm: true,
  breaks: false
});

const projects = [
  {
    title: "rifftales",
    images: [
      "https://res.cloudinary.com/dx8d5hlk1/image/upload/v1765410145/screenshot-rocks_x9b161.png",
      "https://res.cloudinary.com/dx8d5hlk1/image/upload/v1765410146/screenshot-rocks_1_ixoppa.png",
      "https://res.cloudinary.com/dx8d5hlk1/image/upload/v1765410146/screenshot-rocks_2_nklksx.png",
      "https://res.cloudinary.com/dx8d5hlk1/image/upload/v1769166212/edit_cit2nv.png",
      "https://res.cloudinary.com/dx8d5hlk1/image/upload/v1765410146/screenshot-rocks_4_jbjvsa.png",
      "https://res.cloudinary.com/dx8d5hlk1/image/upload/v1765410145/screenshot-rocks_5_btfnqh.png",
      "https://res.cloudinary.com/dx8d5hlk1/image/upload/v1765410145/screenshot-rocks_3_fkuwru.png",
    ],
    site: "https://www.rifftales.net",
    description: `I play the guitar as a hobby and enjoy collecting different types of guitars and gear. 
    I also like seeing what other people have in their collection. 
    This **full-stack app** is my take on building a supportive place for musicians to upload, 
    browse, and show off their musical equipment.<br><br>

The app has **social media elements**: users can like, comment, and discuss each other's gear, 
helping build a community of musicians and gear enthusiasts who love sharing their setups and getting 
inspiration from others.<br><br>

**Technical details:**<br>

• Backend: Node.js + Express with Mongoose and MongoDB<br>
• Authentication: Custom passwordless login (magic links) for the smoothest possible user experience<br>
• Frontend: React with Context API for global state management and Tailwind CSS for fast, responsive styling<br><br>
It's a passion project that combines my love for guitars with software development, focused on speed, usability, and bringing musicians together around the gear they love.`,
    tech: [
      { icon: "bx bxl-javascript", name: "JavaScript" },
      { icon: "bx bxl-nodejs", name: "NodeJS" },
      { icon: "bx bxl-mongodb", name: "MongoDB" },
      { icon: "bx bxl-react", name: "React" },
      { icon: "bx bxl-tailwind-css", name: "Tailwind CSS" },
      { icon: "bx bxl-html5", name: "HTML5" },
      { icon: "bx bxl-git", name: "Git" },
      { icon: "bx bxl-visual-studio", name: "VSCode" }
    ]
  },
    {
    title: "Simple Weight Loss Tracker",
    images: [
      "/assets/img/weightloss.png"
    ],
    site: "http://www.simpleweightlosstracker.co.uk",
    description: `I'm currently on a **weight loss journey** so I wrote this to keep track of my progress.<br><br>
    There are plenty of weight loss trackers out there, but I wanted to build one that was **private and ad free**.<br><br>
    The app is built with **plain JavaScript and Chart.js**. I chose to build inside Astro.js for convenience as it already has routing and markdown support built-in.`,
    tech: [
      { icon: "bx bxl-javascript", name: "JavaScript" },
      { icon: "bx bxl-html5", name: "HTML5" },
      { icon: "bx bxl-git", name: "Git" },
      { icon: "bx bxl-visual-studio", name: "VSCode" }
    ]
  },
  {
    title: "whatsthescore",
    images: [
      "/assets/img/whatsthescore2025.png"
    ],
    site: "https://whatsthescore.netlify.app/",
    source: "https://github.com/tabrezakhtar/whatsthescore-web",
    description: `I built this app as a way of keeping the score during a **tennis match**. <br><br>
    Sometimes during a long match, it's easy to forget! The UI is designed to be as **simple as possible**, with only 2 buttons to control the score.<br><br>
To build this project, I used **React with the Context API** and styled it using BeerCSS for a Material theme. <br><br>
The module to model the tennis score is built with a **Test-Driven approach using Jest**, since tennis scoring has a lot of edge cases that can easily slip through without tests.`,
    tech: [
      { icon: "bx bxl-javascript", name: "JavaScript" },
      { icon: "bx bxl-react", name: "React" },
      { icon: "bx bxl-html5", name: "HTML5" },
      { icon: "bx bxl-git", name: "Git" },
      { icon: "bx bxl-visual-studio", name: "VSCode" }
    ]
  }
];
---
<section id="projects" class="projects section-bg">
  <div class="container">
    <div class="section-title">
      <h2>My Projects</h2>
      <p>
        Here are some of the projects that I am working on now.
      </p>
    </div>
    {projects.map(project => (
      <div class="row" data-aos="fade-up" data-aos-delay="100">
        <div class="project__container">
          <div class="lhs">
            <div class="image-gallery">
              {/* Main image display with navigation */}
              <div class="main-image-container">
                <img 
                  id={`mainImage${projects.indexOf(project)}`}
                  src={project.images[0]} 
                  class="main-image" 
                  alt={`Screenshot of ${project.title}`}
                  data-current-index="0"
                  data-total-images={project.images.length}
                  onclick={`openCurrentImageModal('modal${projects.indexOf(project)}', 'mainImage${projects.indexOf(project)}', ${JSON.stringify(project.images)})`}
                />
                
                {/* Navigation buttons */}
                {project.images.length > 1 && (
                  <>
                    <button 
                      class="nav-btn prev-btn"
                      onclick={`navigateImage('mainImage${projects.indexOf(project)}', -1, ${JSON.stringify(project.images)})`}
                      aria-label="Previous image"
                    >
                      <i class="bx bx-chevron-left"></i>
                    </button>
                    <button 
                      class="nav-btn next-btn"
                      onclick={`navigateImage('mainImage${projects.indexOf(project)}', 1, ${JSON.stringify(project.images)})`}
                      aria-label="Next image"
                    >
                      <i class="bx bx-chevron-right"></i>
                    </button>
                  </>
                )}
              </div>
              
              {/* Thumbnail navigation */}
              {project.images.length > 1 && (
                <div class="thumbnails">
                  {project.images.map((img, imgIndex) => (
                    <img 
                      src={img} 
                      class="thumbnail" 
                      alt={`Screenshot ${imgIndex + 1} of ${project.title}`}
                      onclick={`selectImage('mainImage${projects.indexOf(project)}', '${img}', ${imgIndex})`}
                    />
                  ))}
                </div>
              )}
            </div>
          </div>
          <div class="rhs">
            <span>
              <a class="link h4" href={project.site} target="_blank" rel="opener" referrerpolicy="origin">{project.title}</a>
            </span>
            <div class="project-description" set:html={marked(project.description)} />
            <div class="tech__badges">
              {project.tech.map(t => (
                <div data-aos="flip-left">
                  <i class={t.icon}></i>
                  <span>{t.name}</span>
                </div>
              ))}
            </div>
            <p>
              {project.source && (
                <span>
                  source: <a class="link" href={project.source} target="_blank" rel="opener" referrerpolicy="origin">{project.source}</a>
                </span>
              )}
              {project.site && (
                <span>
                  site: <a class="link" href={project.site} target="_blank" rel="opener" referrerpolicy="origin">{project.site}</a>
                </span>
              )}
            </p>
          </div>
        </div>
      </div>
    ))}
  </div>
</section>

<!-- Image Modals -->
{projects.map((project, index) => (
  <div class="modal fade" id={`modal${index}`} tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{project.title} - Gallery</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <div class="modal-image-gallery">
            <!-- Main image in modal -->
            <div class="modal-main-image-container">
              <img 
                id={`modalImage${index}`}
                src={project.images[0]} 
                class="modal-main-image" 
                alt={`Screenshot of ${project.title}`}
                data-current-index="0"
              />
              
              <!-- Modal navigation buttons -->
              {project.images.length > 1 && (
                <>
                  <button 
                    class="modal-nav-btn modal-prev-btn"
                    onclick={`navigateModalImage('modalImage${index}', -1, ${JSON.stringify(project.images)})`}
                    aria-label="Previous image"
                  >
                    <i class="bx bx-chevron-left"></i>
                  </button>
                  <button 
                    class="modal-nav-btn modal-next-btn"
                    onclick={`navigateModalImage('modalImage${index}', 1, ${JSON.stringify(project.images)})`}
                    aria-label="Next image"
                  >
                    <i class="bx bx-chevron-right"></i>
                  </button>
                </>
              )}
            </div>
            
            <!-- Modal thumbnails -->
            {project.images.length > 1 && (
              <div class="modal-thumbnails">
                {project.images.map((img, imgIndex) => (
                  <img 
                    src={img} 
                    class={`modal-thumbnail ${imgIndex === 0 ? 'active' : ''}`}
                    alt={`Screenshot ${imgIndex + 1} of ${project.title}`}
                    onclick={`selectModalImage('modalImage${index}', '${img}', ${imgIndex})`}
                  />
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  </div>
))}

<script is:inline>
  function navigateImage(imageId, direction, images) {
    const img = document.getElementById(imageId);
    const currentIndex = parseInt(img.getAttribute('data-current-index'));
    const totalImages = images.length;
    
    let newIndex = currentIndex + direction;
    
    // Handle wrapping
    if (newIndex >= totalImages) {
      newIndex = 0;
    } else if (newIndex < 0) {
      newIndex = totalImages - 1;
    }
    
    // Update image
    img.src = images[newIndex];
    img.setAttribute('data-current-index', newIndex);
    
    // Update thumbnail active states
    updateThumbnailStates(imageId, newIndex);
  }
  
  function selectImage(imageId, imageSrc, index) {
    const img = document.getElementById(imageId);
    img.src = imageSrc;
    img.setAttribute('data-current-index', index);
    
    // Update thumbnail active states
    updateThumbnailStates(imageId, index);
  }
  
  function updateThumbnailStates(imageId, activeIndex) {
    // Find the container and update thumbnail states
    const container = document.getElementById(imageId).closest('.image-gallery');
    const thumbnails = container.querySelectorAll('.thumbnail');
    
    thumbnails.forEach((thumbnail, index) => {
      if (index === activeIndex) {
        thumbnail.classList.add('active');
      } else {
        thumbnail.classList.remove('active');
      }
    });
  }
  
  // Function to open modal with current image state
  function openCurrentImageModal(modalId, mainImageId, images) {
    const mainImage = document.getElementById(mainImageId);
    const currentIndex = parseInt(mainImage.getAttribute('data-current-index'));
    const currentSrc = mainImage.src;
    
    openImageModal(modalId, currentSrc, currentIndex, images);
  }
  
  // Modal functions
  function openImageModal(modalId, imageSrc, index, images) {
    // Hide mobile nav toggle
    const mobileNavToggle = document.querySelector('.mobile-nav-toggle');
    if (mobileNavToggle) {
      mobileNavToggle.style.display = 'none';
    }
    
    const modal = new bootstrap.Modal(document.getElementById(modalId));
    const modalImage = document.querySelector(`#${modalId} .modal-main-image`);
    
    modalImage.src = imageSrc;
    modalImage.setAttribute('data-current-index', index);
    
    // Update modal thumbnail states
    updateModalThumbnailStates(modalId, index);
    
    modal.show();
    
    // Add event listener to show mobile nav toggle when modal is hidden
    const modalElement = document.getElementById(modalId);
    modalElement.addEventListener('hidden.bs.modal', function() {
      if (mobileNavToggle) {
        mobileNavToggle.style.display = '';
      }
    }, { once: true });
  }
  
  function navigateModalImage(imageId, direction, images) {
    const img = document.getElementById(imageId);
    const currentIndex = parseInt(img.getAttribute('data-current-index'));
    const totalImages = images.length;
    
    let newIndex = currentIndex + direction;
    
    // Handle wrapping
    if (newIndex >= totalImages) {
      newIndex = 0;
    } else if (newIndex < 0) {
      newIndex = totalImages - 1;
    }
    
    // Update image
    img.src = images[newIndex];
    img.setAttribute('data-current-index', newIndex);
    
    // Update modal thumbnail states
    const modalId = img.closest('.modal').id;
    updateModalThumbnailStates(modalId, newIndex);
  }
  
  function selectModalImage(imageId, imageSrc, index) {
    const img = document.getElementById(imageId);
    img.src = imageSrc;
    img.setAttribute('data-current-index', index);
    
    // Update modal thumbnail states
    const modalId = img.closest('.modal').id;
    updateModalThumbnailStates(modalId, index);
  }
  
  function updateModalThumbnailStates(modalId, activeIndex) {
    const modal = document.getElementById(modalId);
    const thumbnails = modal.querySelectorAll('.modal-thumbnail');
    
    thumbnails.forEach((thumbnail, index) => {
      if (index === activeIndex) {
        thumbnail.classList.add('active');
      } else {
        thumbnail.classList.remove('active');
      }
    });
  }
</script>


<style>
  .project__container {
    display: flex;
    border-bottom: 1px solid $divider-color;
  }

  @media (max-width: 720px) {
    .project__container {
      display: block;
    }
  }


  .project__container .lhs {
    flex: 0 1 calc(30%);
    display: flex;
    justify-content: start;
    align-items: flex-start;
    flex-direction: column;
  }

  @media (max-width: 720px) {
    .project__container .lhs {
      align-items: center;
    }
  }

  .image-gallery {
    width: 24rem;
    margin-top: 2rem;
    max-width: 100%;
  }

  .main-image-container {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 1rem;
    width: 100%;
    max-width: 400px;
  }

  .main-image {
    width: 100%;
    height: 300px;
    object-fit: contain;
    transition: transform 0.3s ease;
    cursor: pointer;
  }

  .main-image:hover {
    transform: scale(1.02);
  }

  .nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 128, 128, 0.8);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 0;
  }

  .main-image-container:hover .nav-btn {
    opacity: 1;
  }

  .nav-btn:hover {
    background: rgba(0, 128, 128, 1);
    transform: translateY(-50%) scale(1.1);
  }

  .prev-btn {
    left: 15px;
  }

  .next-btn {
    right: 15px;
  }

  .thumbnails {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: flex-start;
    padding-bottom: 0.5rem;
    width: 100%;
  }

  .thumbnail {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .thumbnail:hover {
    border-color: #008080;
    transform: scale(1.05);
  }

  .thumbnail.active {
    border-color: #008080;
    border-width: 3px;
  }

  @media (max-width: 720px) {
    .image-gallery {
      width: 35rem;
    }
    
    .thumbnail {
      width: 50px;
      height: 50px;
    }
  }

  .project__container .rhs {
    justify-content: center;
    flex: 1;
    padding: 2rem;
  }

  .project__container .rhs span {
    display: block;
    padding-bottom: 1rem;
  }

  .project__container .rhs p {
    padding-bottom: 1rem;
  }

  .project-description p {
    margin-bottom: 1rem;
  }

  .project-description ul {
    margin: 1rem 0;
    padding-left: 2rem;
    list-style-type: disc;
  }

  .project-description li {
    margin-bottom: 0.5rem;
    display: list-item;
    list-style-type: disc;
    list-style-position: outside;
  }

  .project-description strong {
    font-weight: bold;
  }

  .project__container .rhs .tech__badges {
    justify-content: left;
    padding-top: 1.5rem;
  }

  .project__container .rhs .tech__badges img {
    width: 3rem;
  }

  .link {
    font-weight: bold;
    color: #008080;
    text-decoration: underline;
  }

  /* Modal Styles */
  .modal-xl {
    max-width: 1200px;
  }

  @media (max-width: 1400px) {
    .modal-xl {
      max-width: 90vw;
    }
  }

  .modal-image-gallery {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
  }

  .modal-main-image-container {
    position: relative;
    width: 100%;
    max-width: 800px;
    margin-bottom: 1rem;
  }

  .modal-main-image {
    width: 100%;
    max-height: 70vh;
    object-fit: contain;
    border-radius: 8px;
  }

  .modal-nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.7);
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 10;
  }

  .modal-nav-btn:hover {
    background: rgba(0, 128, 128, 0.9);
    transform: translateY(-50%) scale(1.1);
  }

  .modal-prev-btn {
    left: 20px;
  }

  .modal-next-btn {
    right: 20px;
  }

  .modal-thumbnails {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    max-width: 800px;
    overflow-x: auto;
    padding: 0.5rem;
  }

  .modal-thumbnail {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .modal-thumbnail:hover {
    border-color: #008080;
    transform: scale(1.05);
  }

  .modal-thumbnail.active {
    border-color: #008080;
    border-width: 4px;
  }

  @media (max-width: 768px) {
    .modal-xl {
      max-width: 95vw;
    }
    
    .modal-main-image {
      max-height: 60vh;
    }
    
    .modal-thumbnail {
      width: 60px;
      height: 60px;
    }
    
    .modal-nav-btn {
      width: 40px;
      height: 40px;
      font-size: 20px;
    }
  }


</style>
